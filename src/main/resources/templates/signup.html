<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>BlockChef 회원가입</title>
    <script>
        let emailVerified = false;

        async function sendVerificationCode() {
          const email = document.getElementById("email").value;

          const response = await fetch("/auth/email/send-code", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ email })
          });

          const result = await response.text();
          alert(result);
        }

        async function verifyCode() {
          const email = document.getElementById("email").value;
          const code = document.getElementById("emailCode").value;

          const response = await fetch("/auth/email/verify-code", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ email, code })
          });

          if (response.ok) {
            alert("이메일 인증 성공!");
            emailVerified = true;
            document.getElementById("signupBtn").disabled = false;
          } else {
            alert("인증 실패. 인증번호를 다시 확인하세요.");
            emailVerified = false;
            document.getElementById("signupBtn").disabled = true;
          }
        }

        async function signup() {
          if (!emailVerified) {
            alert("이메일 인증을 먼저 완료해주세요.");
            return;
          }

          const email = document.getElementById("email").value;
          const name = document.getElementById("name").value;
          const password = document.getElementById("password").value;
          const confirm = document.getElementById("passwordConfirm").value;

          if (password !== confirm) {
            alert("비밀번호가 일치하지 않습니다.");
            return;
          }

          const response = await fetch("/users/signup", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ email, name, password, passwordConfirm: confirm })
          });

          if (response.ok) {
            alert("회원가입 성공!");
            location.href = "/";
          } else {
            const error = await response.text();
            alert("회원가입 실패: " + error);
          }
        }
    </script>
</head>
<body>
<h2>회원가입</h2>

<label>이메일:</label>
<input type="email" id="email" required />
<button onclick="sendVerificationCode()">인증번호 전송</button>
<br><br>

<label>인증번호:</label>
<input type="text" id="emailCode" />
<button onclick="verifyCode()">인증 확인</button>
<br><br>

<label>이름:</label>
<input type="text" id="name" required />
<br><br>

<label>비밀번호:</label>
<input type="password" id="password" required />
<br>

<label>비밀번호 확인:</label>
<input type="password" id="passwordConfirm" required />
<br><br>

<button id="signupBtn" onclick="signup()" disabled>회원가입</button>
</body>
</html>
